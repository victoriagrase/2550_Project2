---
title: "PHP 2550 Project 2"
author: "Victoria Grase"
date: "2023-11-12"
output:
  pdf_document: default
  html_document: default
format: pdf
---

```{r,include=FALSE}
library(knitr)
library(kableExtra)
library(Rfast)
library(mvtnorm)
library(glmnet)
library(leaps)
library(broom)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gtsummary)
library(tidyverse)
library(knitr)
library(mice)
library(naniar)
library(HDSinRdata) # version 0.1.0
library(readxl)
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see
<http://rmarkdown.rstudio.com>.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.\

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
project2<-read.csv("C:/Users/CAU Student/Documents/GitHub/2550_Project2/project2.csv")
#project2_codebook<-read_excel("C:/Users/CAU Student/Documents/GitHub/2550_Project2/project2_codebook.xlsx")

```

## Abstract

In this analysis project, I propose a novel approach for predicting the composite outcome of tracheostomy, a critical medical procedure, with the aim of guiding indication criteria and optimizing the timing of tracheostomy placement. I use a combination of advanced statistical techniques, including Lasso regression and multilevel regression models, enhanced by a backward selection process. These methods are applied to a comprehensive dataset provided by (ENTER DR NAME) to improve the accuracy of outcome predictions. This analysis leverages the power of Lasso regression, which provides variable selection and regularization to enhance model efficiency and interpretability. The Lasso model helps identify the most influential predictors in determining the need for tracheostomy and its optimal timing. While the multilevel approach allows us to assess the impact of health center-specific factors on tracheostomy outcomes. It can account for the hierarchical structure of the data, considering both individual patient-level predictors and the characteristics of the healthcare centers.By examining these variations, we aim to identify best practices and potential areas for improvement in tracheostomy procedure. To address issues of missing data, multiple imputation techniques were used to ensure robust and reliable results. This study provides valuable insights that can aid healthcare professionals in making informed decisions about tracheostomy, ultimately improving patient outcomes and healthcare resource allocation. This research contributes to the ongoing efforts to enhance clinical decision-making in the context of tracheostomy procedures.

## Introduction:
The primary objective of this investigation is to construct a robust regression model tailored to predict the composite outcome of tracheostomy, thereby offering valuable guidance on the indication criteria and optimal timing for tracheostomy placement. A distinctive aspect of this model development lies in its focus on statistical variables collected at both 36 and 44 weeks of gestation, providing a comprehensive understanding of factors influencing the likelihood of tracheostomy. The variables of particular interest encompass birth-related factors such as weight, gestational age, the administration of prenatal steroids for lung development, maternal race, gender (acknowledging potential gender-based differences in outcomes), and the presence of chorioamnionitis, an infection of the amniotic fluid. Additionally, variables recorded at 36 and 44 weeks, including weight and the eventual need for tracheostomy, contribute crucial insights into the predictive dynamics.

In addition of this investigation, it is essential to include additional variables that contribute significantly to the predictive accuracy of the model. Factors such as the respiratory support level and the presence of pulmonary hypertension, known risk factors, are integral to capturing the complexity of tracheostomy outcomes. Furthermore, recognizing the diversity in medical practices across different centers, the variable of medical center becomes pivotal. Some medical centers serve as referral centers with specialized practices, often being academic tertiary centers. To look at these these distinctions, an approach is to incorporate the medical center as a categorical covariate in the model, considering it as an interaction term to account for center-specific patterns. Additionally, the inclusion of surfactant as a variable, a substance aiding in maintaining lung inflation and developing around 34 weeks, further refines the model's capacity to predict tracheostomy outcomes. The nature of these variables ensures that the regression model not only addresses the core predictors but also the complexity associated with medical practices, respiratory support, and additional risk factors important for the tracheostomy outcome prediction.

The report gives detailed description and interpretation of four distinct models, namely lasso, binomial logistic, backward, and forward stepwise selection. These models serve as analytical models show relationships between the identified key variables and predictions for diverse subset of infants. This  exploration extends to the application of a sensitivity analysis, leveraging various methods such as cross-validation, F-score, and Brier score. The sensitivity analysis aims to examine the robustness and reliability of the models in capturing variations of the data. The comprehensive evaluation gives an understanding of how different variables interplay in influencing the composite outcome of tracheostomy. And our analysis gives a recommendation for the best robust model of that would be best to use in real world examples by looking at completed data through imputation. This method offers meaningful insight into the intricate dynamics surrounding the indication criteria and timing of tracheostomy placement.

#### Re-formatting and Missing Data of Study 

First, my aim is to enhance the data integrity by reformatting it, addressing any outliers or missing values that could potentially introduce bias or skew the results. To achieve this, I applied factorization to variables including center, race, ethnicity, delivery method, prenatal steroid administration, chorioamnionitis, gender, and surfactant status. Additionally, ventilation support level and medication for pulmonary hypertension were factored at both 36 and 44 weeks to assess baseline characteristics concerning the binomial outcome of Tracheostomy. During this process, I identified and removed duplicate entries for a specific patient, ensuring the dataset's consistency. Furthermore, an outlier affecting gestational age was identified and subsequently excluded to maintain the statistical robustness of the analyses.

Next, I looked at missing data patterns in variables across the dataset provided.. Among the variables examined, Inspired Oxygen at 44 weeks exhibits the highest degree of missingness, with 44.98% of the data absent, followed closely by Peak Inspiratory Pressure (p_delta.44) and infant weight at 44 weeks, both with a missingness rate of 44.98% and 44.78%, respectively. Similarly, Positive End Exploratory Pressure (peep_cm_h2o_modified.44), the binary variable indicating the administration of any surfactant (any_surf), and the modified ventilation support level at 44 weeks display substantial missing data, each at a rate exceeding 40%. Notably, Medication for Pulmonary Hypertension at 44 weeks (med_ph.44), Composite Prenatal Steroids (com_prenat_ster), and Positive End Exploratory Pressure at 36 weeks (p_delta.36) exhibit relatively lower missingness rates ranging from 12.45% to 19.38%.As you can see from the table there seems to be a lot of missing values for the 44 week time period. It's essential to acknowledge a limitation in the form of higher missing data for variables at 44 weeks compared to those at 36 weeks. This discrepancy can be attributed to discharges occurring between the 36 and 44 weeks, introducing challenges in data collection during this interval. This limitation underscores the need for careful consideration and potential adjustment for missing data when interpreting and generalizing the study's findings.


```{r, include=TRUE}
# Find duplicate rows
duplicates <- project2[duplicated(project2) | duplicated(project2, fromLast = TRUE), ]

# Display duplicate rows
print(duplicates)
row_to_remove <-c(790,791,792)
project2<-project2[-row_to_remove, ]

# factorize the categorical data
project2[,c(2,3,4,9,17,21,23,27,29)]<-project2[,c(2,3,4,9,17,21,23,27,29)] %>%
  mutate_if(is.integer,factor)

project2[,c(10:15)]<- project2[,c(10:15)] %>%
  mutate_if(is.character, factor) 

overall_missing<-miss_var_summary(project2)
print(overall_missing)

#Look at missing data for each parent 
pct_na_r <- rowSums(is.na(project2)) / ncol(project2) * 100
row_na <- data.frame(record_id = project2$record_id, pct_na = pct_na_r)
row_na <- row_na[row_na$pct_na > 35,] 
print(row_na)
```
### Study Characteristics and Population 
The dataset comprises information from 996 participants encompassing a total of 28 variables, offering a comprehensive representation of demographics, gestational age, birthweight, prenatal steroid administration (facilitating lung development), maternal race/ethnicity, gender (acknowledging gender-based differences), and the presence of chorioamnionitis (an infection of the amniotic fluid). Additionally, the study captures measurements at both 36 and 44 weeks for critical variables such as Peak Inspiratory Pressure, Positive End Exploratory Pressure, Medication for Pulmonary Hypertension, weight, ventilation support level, and fraction of inspired oxygen. Within this wealth of data, binary potential outcomes were recorded, presenting opportunities for evaluating the goal of determining optimal tracheostomy placement timing, with death and the presence of tracheostomy being key outcomes of interest. To streamline the analysis and enhance interpretability, the focus was deliberately narrowed down to the binomial outcome variable "Trach" to discern the best-fitting model for achieving the study's goals.

```{r, include=TRUE}

#Create severity of BPD variable indicator at week 36 
project2<-project2%>% mutate(severity = case_when(
  (ventilation_support_level.36 == 0 | 
     (ventilation_support_level.36 == 1  & inspired_oxygen.36 < 0.22)) ~ 'Mild', 
  ((ventilation_support_level.36 == 2 & inspired_oxygen.36 <= 0.21) | 
     (ventilation_support_level.36 == 1 & inspired_oxygen.36 < 0.30 & inspired_oxygen.36 >= 0.22)) ~ 'Moderate',
   ((ventilation_support_level.36 == 2 & inspired_oxygen.36 > 0.21) |
      (ventilation_support_level.36 == 1 & inspired_oxygen.36 >= 0.30)) ~ 'Severe'))


baseline_char<-project2%>%
  select(center, mat_race,mat_ethn,del_method,gender,sga, any_surf,Trach) %>%
  tbl_summary(missing = "no") %>%
  add_n(statistic = "{n_miss} ({p_miss}%)") %>%
  modify_header(n = "N Missing") %>%
  knitr::kable(caption = "Summary of Demographics and Infant Delivery", col.names = c("Characteristic", "N Missing", "N =996 ") ) %>%
  kableExtra::kable_styling(latex_options = c("striped"),stripe_color = "gray!15")

baseline_char


baseline_info<-
  project2%>%
  select(prenat_ster,com_prenat_ster,mat_chorio,weight_today.36,ventilation_support_level.36,inspired_oxygen.36,p_delta.36,peep_cm_h2o_modified.36, med_ph.36,weight_today.44, ventilation_support_level_modified.44,inspired_oxygen.44,p_delta.44,peep_cm_h2o_modified.44,med_ph.44,hosp_dc_ga) %>%
  tbl_summary(missing = "no",) %>%
  add_n(statistic = "{n_miss} ({p_miss}%)") %>%
  modify_header(n = "N Missing") %>%
  knitr::kable(caption = "Summary of Infant Information", col.names = c("Characteristic", "N Missing", "N =996 ") ) %>%
  kableExtra::kable_styling(latex_options = c("striped"),stripe_color = "gray!15")

baseline_info


```


```{r, include=TRUE}
#Summary of variables stratified by Tracheostomy

table1<-project2 %>%
  select(gender, bw,blength,birth_hc,weight_today.36, weight_today.44,Trach) %>%
    tbl_summary(
      by = Trach,
      type = all_continuous() ~ "continuous2",
      statistic = all_continuous() ~ c("{mean}"),
      missing_text = "Missing",
      label = list(bw = "Average Birth Weight {g}", 
                   blength="Average Height of Infant {cm}",
                   birth_hc="Average Circumference of Infant Head {cm}",
                  weight_today.36 = "Average Weight at 36 Weeks {g}", 
                  weight_today.44 = "Average Weight at 44 Weeks {g}")) %>%
      add_overall() %>%
      modify_header(label ~ "**Variable**") %>%
      modify_caption("**Table 1. Average Birth and Infants Weights and Heights**") %>%
      modify_spanning_header(c("stat_1", "stat_2") ~ "**Trach**") %>%
      bold_labels()
table1


table2<-project2 %>%
  select(Trach,inspired_oxygen.36,inspired_oxygen.44,p_delta.36,p_delta.44,hosp_dc_ga,peep_cm_h2o_modified.36,peep_cm_h2o_modified.44) %>%
    tbl_summary(
      by = Trach,
      type = all_continuous() ~ "continuous2",
      statistic = all_continuous() ~ c("{mean}"),
      missing_text = "Missing",
      label = list(inspired_oxygen.36 = "Fraction of Inspired Oxygen at 36 weeks", 
                   inspired_oxygen.44= "Fraction of Inspired Oxygen at 44 weeks",
                   p_delta.36="Peak Inspiratory Pressure (cmH2O) at 36 weeks",
                   p_delta.44="Peak Inspiratory Pressure (cmH2O) at 44 weeks",
                   peep_cm_h2o_modified.36="Positive and exploratory pressure (cm H2O) at 36 weeks",peep_cm_h2o_modified.44="Positive and exploratory pressure (cm H2O) at 44 weeks",
                   hosp_dc_ga="Hospital Discharge Gestational Age")) %>%
      add_overall() %>%
      modify_header(label ~ "**Variable**") %>%
      modify_caption("**Table 2: Average of Oxygen, Pressure, and Gestiational Age**") %>%
      modify_spanning_header(c("stat_1", "stat_2") ~ "**Trach**") %>%
      bold_labels()
table2


# name the values for the mother's race and the mother's ethnicity
project2$mother_ethn <- ifelse(project2$mat_ethn == 1, 
                               "Hispanic or Latino","Not Hispanic or Latino")
project2$mother_race<-
  case_when(
    project2$mat_race == 0 ~ "American Indian or Alaskan Native",
    project2$mat_race == 1 ~ "Asian",
    project2$mat_race == 3 ~ "Black or African American",
    project2$mat_race == 4 ~ "Native Hawaiian or Other Pacific Islander",
    project2$mat_race == 5 ~ "White",
    project2$mat_race == 2 ~ "Other")

project2$severity<-
  case_when(
    project2$severity == 1 ~ "Mild",
    project2$severity == 2~ "Moderate",
    project2$severity == 3~ "Severe")


# table displaying the summary of the mother's race and ethnicity
table3<-project2 %>%
  select(mother_race, mother_ethn,severity) %>%
  tbl_summary(
    by = mother_ethn, missing_text = "Missing",
    label = list(mother_race = "Race of Mother",
                 severity= "Severity of BPD")) %>% 
  add_overall() %>%
  modify_header(label ~ " ") %>%
  modify_caption("**Table 3: Maternal Demographics**") %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Ethnicity of Mother**") %>%
  bold_labels()
table3

# average tracheostomy at discharge and death before discharge
table4<-project2 %>%
  select(Trach, gender, prenat_ster,del_method,ventilation_support_level.36,ventilation_support_level_modified.44, com_prenat_ster, mat_chorio,med_ph.36,med_ph.44) %>%
  tbl_summary(
    by = Trach,
    type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c("{median}"),
    missing_text = "Missing",
    label = list(prenat_ster = "Prenatal Steroids",
                 del_method= "Delivery Method",
                 ventilation_support_level.36="Ventilation support level at 36 weeks",
                 ventilation_support_level_modified.44="Ventilation support level at 44 weeks",
                 com_prenat_ster = "Completed Prenatal Steroids",
                 mat_chorio = "Maternal Chorioamnionitis",
                 gender = "Average #",
                 med_ph.36="Medication for Pulmonary Hypertension at 36 weeks",
                 med_ph.44="Medication for Pulmonary Hypertension at 44 weeks",
                 center= "Medical Center")) %>% 
  add_overall() %>%
  modify_header(label ~ " ") %>%
  modify_caption("**Table 4: Summary of Steroid Status, Chorioamnionitis,and Ventilation**") %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Trach**") %>%
  bold_labels()
table4
```
DESCRIPTION OF TABLES 

## Methods

 Initially, a subset of variables deemed critical for the analysis is selected and appropriately renaTo address missing values, the Multiple Imputation by Chained Equations (MICE) method is employed, generating five imputed datasets to ensure robustness and account for uncertainty in the imputation process. A random seed is set to enhance reproducibility. The imputed datasets are stored in a list for further analysis, and the mice::complete function is utilized to obtain the completed datasets for each imputation iteration. The entire imputation process is then saved as an RDS file to preserve the imputed datasets for future analyses.

Visualization of the imputed datasets is shown through a plot looking at distribution and patterns of imputed values. The imputation methods used can be inspected through the trache_mice$method attribute. Finally, the imputed datasets are made into a dataframe named completed_data using the complete function, which aggregates the imputed values into a single dataset, ready for subsequent analyses. This imputation process is essential for ensuring a more robust and complete dataset, enhancing the reliability of statistical analyses and model building in which we will need for the following regression: lasso, logistic, forward, and backward. 
```{r}
# Select variables and rename
project2<- project2 %>% select(c(center,bw,ga,blength,birth_hc,del_method,prenat_ster,com_prenat_ster,mat_chorio,gender,sga,any_surf,weight_today.36,ventilation_support_level.36,inspired_oxygen.36,p_delta.36,peep_cm_h2o_modified.36, med_ph.36,weight_today.44, ventilation_support_level_modified.44,inspired_oxygen.44,p_delta.44,peep_cm_h2o_modified.44,med_ph.44,hosp_dc_ga,Trach))
#Create imputation for variables at 44 weeks including weight, Fraction of Inspired Oxygen,Peak Inspiratory Pressur, Positive end exploratory pressure, 

#Perform multiple imputation (generating 5 imputed datasets)
# Set a random seed for reproducibility
trache_mice<- mice(project2, m = 5, seed = 10)
# Store each imputed data set
trache_imputed<- vector("list",5) 
for (i in 1:5){
  trache_imputed[[i]] <- mice::complete(trache_mice,i) 
}
saveRDS(trache_mice,file="trache_mice.RDS")
trache_mice<- readRDS("trache_mice.RDS")
plot(trache_mice)
trache_mice$method
#View the imputed datasets in the 
completed_data<- complete(trache_mice)
#columns_to_remove <-c(30,31,32)
#completed_data<-completed_data[,-columns_to_remove ]

#overall_missing1<-miss_var_summary(completed_data)
#overall_missing1

```

```{r}
lasso <- function(df) { 
  #' Runs 10-fold CV for lasso and returns corresponding coefficients 
  #' @param df, data set
  #' @return coef, coefficients for minimum cv error
  
  # Matrix form for ordered variables 
  x.ord <- model.matrix(Trach~.^2, data =df)[,-1] 
  y.ord <- df$Trach
  # Assuming you have a data frame or matrix named 'data'
# Subsample 'y' to match the number of rows in 'x'
  #set.seed(123)  # for reproducibility


  
  # Generate folds
  k <- 10 
  set.seed(1) # consistent seeds between imputed data sets
  folds <- sample(1:k, nrow(df), replace=TRUE)
  
  # Lasso model
  lasso_mod <- cv.glmnet(x.ord, y.ord, nfolds = 10, foldid = folds, 
                         alpha = 1, family = "binomial") 
  
  # Get coefficients 
  coef <- coef(lasso_mod, lambda = lasso_mod$lambda.min) 
  return(coef) 
} 


# Find average lasso coefficients ovetr imputed datasets
lasso_coef1 <- lasso(trache_imputed[[1]]) 
lasso_coef2 <- lasso(trache_imputed[[2]]) 
lasso_coef3 <- lasso(trache_imputed[[3]]) 
lasso_coef4 <- lasso(trache_imputed[[4]]) 
lasso_coef5 <- lasso(trache_imputed[[5]]) 
lasso_coef <- cbind(lasso_coef1, lasso_coef2, lasso_coef3, 
                    lasso_coef4, lasso_coef5) 
avg_coefs_lasso <- apply(lasso_coef, 1, mean) 

# Find predicted probabilities on long imputed data (no rounding applied in this case!)
trach_df_long<- mice::complete(trache_mice,action="long") 
x_vars <- model.matrix(Trach~.^2 , trach_df_long)[,-c(2,3)]
trach_df_long$lasso<- x_vars%*% avg_coefs_lasso
mod_lasso <- glm(Trach~lasso, data = trach_df_long, family = "binomial")
predict_probs_lasso<- predict(mod_lasso, type="response")

```

```{r}
# Binomial logistic regression 
logistic <- function(df) { 
  
  x.ord <- model.matrix(Trach~., data = df)[,-1] 
  y.ord <- df$Trach 
  
  # logistic model
  logistic_mod<- glm(y.ord~x.ord, family = "binomial") 
  
  # Get coefficients 
  coef <- coef(logistic_mod) 
  return(coef) 
} 

# Find average logistic coefficients over imputed datasets
logistic_coef1<- logistic(trache_imputed[[1]]) 
logistic_coef2<- logistic(trache_imputed[[2]]) 
logistic_coef3<- logistic(trache_imputed[[3]]) 
logistic_coef4<- logistic(trache_imputed[[4]]) 
logistic_coef5<- logistic(trache_imputed[[5]]) 
logistic_coef<-cbind(logistic_coef1, logistic_coef2, logistic_coef3, 
                    logistic_coef4, logistic_coef5) 
avg_coefs_logistic <- apply(logistic_coef, 1, mean) 


# Find predicted probabilities on long imputed data (no rounding applied in this case!)
trach_df_long<- mice::complete(trache_mice,action="long") 
x_vars <- model.matrix(Trach~.^2, trach_df_long)[,-c(2,3)]
trach_df_long$logistic<- x_vars %*% avg_coefs_logistic
mod_logistic<- glm(Trach~logistic, data = trach_df_long, family = "binomial")
predict_probs_lasso<- predict(mod_logistic, type="response")

```

```{r}
# #Forwards Selection 
# 
#   ###FIT FORWARD STEPWISE
#   #ran into an error writing this into a function :(
# 
#   predict.regsubsets <- function(object , newdata , id , ...) {
#    form <- as.formula(object$call[[2]])
#    mat <- model.matrix(form , newdata )
#    coefi <- coef( object , id = id )
#    xvars <- names(coefi)
#    mat[,xvars] %*% coefi
#   }
#  
#   #list to store metrics for different settings
#   metrics <- list(length = 4)
#   
#  for(m in 1:4){
#   #choose among models of different sizes using cv
#   k <- 10
#   n <- nrow()
#   set.seed(1)
#   folds <- sample(rep(1:k, length = n))
#   cv.errors <- matrix(NA, k, 10, dimnames = list(NULL, paste(1:10)))
#   
#   for(j in 1:k)
#   {
#     best.fit<- step(Trach~ ., data = df, nvmax = 10,
#                            method = "forward")
#     for(i in 1:10) 
#     {
#       pred <- predict.regsubsets(best.fit, validationdata[folds == j,], id = i)
#       cv.errors[j, i] <- 
#         mean((validationdata$Y[folds == j] - pred)^2)
#     }
#   }




```

```{r}
#Backwards Selection 



```
# Statistical Analysis



```{r}
#Table for AIC AND BIC
#Lok at F score
#Look at sensitivity analysis nand come up with the RPV the code is in alices book and look in slack 


```

## Results

#Read the documentation and look at two way interactions in the #USe it in cross vaidation sens for a better model #You can consider the #Look at the imputed data and make it like its using a linear mode and the


##Discussion



### Limitations
The analysis and study of tracheostomy placement for infants faces several limitations that impact the comprehensiveness of its findings. One notable constraint is the absence of precise information regarding the timing of tracheostomy placement, hindering timelines critical for clinical decision-making. This limitation obscures potential insights into developmental stages where tracheostomies might be most efficacious. Another limitation arises from the exclusion of infants with genetic anomalies, particularly heart disease, a significant contributor to infant mortality. By not considering this subset, the study might overlook essential factors influencing both the occurrence of tracheostomy placement and broader health outcomes.

Furthermore,there is  a methodological limitation due to the lack of separation in the analysis between 36 and 44 weeks, preventing identification of developmental changes and/or patterns during these gestational periods. This can obscure fine differences in predictive variables and tracheostomy outcomes at distinct gestational ages. Additionally, the focus on tracheostomy placement, neglecting death due to other causes, represents a further limitation. The study may fail to capture the broader spectrum of mortality risks, hindering intervention strategies for infants in a specific population. Incorporating a broader consideration of mortality data would enhance the study's utility and provide a more holistic perspective on the complexities surrounding both tracheostomy placement and mortality in infants.




## References:

\newpage

# Code Appendix

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE, include=TRUE}

```
